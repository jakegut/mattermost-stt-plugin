<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<script>
		window.addEventListener("load", function (evt) {
			let websocket_uri = "ws://localhost:8080/echo";
			let bufferSize = 4096,
				AudioContext,
				context,
				processor,
				input,
				globalRecorder,
				websocket;
			var print = function (message) {
				var d = document.createElement("div");
				d.textContent = message;
				output.appendChild(d);
				output.scroll(0, output.scrollHeight);
			};
			document.getElementById("close").onclick = function (evt) {
				if (!websocket) {
					return false;
				}
				websocket.close();
				return false;
			};
			document.getElementById("open").onclick = function (evt) {
				if (websocket) {
					return false;
				}
				initWebSocket();
				return false;
			}
			function startRecording() {
				streamStreaming = true;

				var handleSuccess = function (stream) {
					console.log('success');
					globalRecorder = new MediaRecorder(stream, {
						mimeType: 'audio/webm;codecs=pcm',
					});

					console.log('media')

					globalRecorder.addEventListener('dataavailable', async (ev) => {
						const buf = await ev.data.arrayBuffer()
						console.log(buf)
						websocket.send(buf);
					});

					console.log('start');

					globalRecorder.start(1000);
				};

				navigator.mediaDevices.getUserMedia({
					audio: {
						autoGainControl: true,
						echoCancellation: true,
						noiseSuppression: true,
					}, video: false
				}).then(handleSuccess);
			} // closes function startRecording()
			function stopRecording() {
				streamStreaming = false;

				globalRecorder.stop();
			} // closes function stopRecording()
			function initWebSocket() {
				// Create WebSocket
				websocket = new WebSocket(websocket_uri);
				//console.log("Websocket created...");

				// WebSocket Definitions: executed when triggered webSocketStatus
				websocket.onopen = function () {
					console.log("connected to server");
					//websocket.send("CONNECTED TO YOU");
					print('Connected');
					startRecording();
				}

				websocket.onclose = function (e) {
					console.log("connection closed (" + e.code + ")");
					print('Not Connected');
				}

				websocket.onmessage = function (e) {
					//console.log("message received: " + e.data);
					console.log(e.data);

					print(e.data)

					if (typeof (result) !== 'undefined' && typeof (result.error) !== 'undefined') {
						print('error!')
					}
				}
			} // closes function initWebSocket()
			function downsampleBuffer(buffer, sampleRate, outSampleRate) {
				if (outSampleRate == sampleRate) {
					return buffer;
				}
				if (outSampleRate > sampleRate) {
					throw 'downsampling rate show be smaller than original sample rate';
				}
				var sampleRateRatio = sampleRate / outSampleRate;
				var newLength = Math.round(buffer.length / sampleRateRatio);
				var result = new Int16Array(newLength);
				var offsetResult = 0;
				var offsetBuffer = 0;
				while (offsetResult < result.length) {
					var nextOffsetBuffer = Math.round((offsetResult + 1) * sampleRateRatio);
					var accum = 0,
						count = 0;
					for (var i = offsetBuffer; i < nextOffsetBuffer && i < buffer.length; i++) {
						accum += buffer[i];
						count++;
					}

					result[offsetResult] = Math.min(1, accum / count) * 0x7fff;
					offsetResult++;
					offsetBuffer = nextOffsetBuffer;
				}
				return result.buffer;
			} // closes function downsampleBuffer()
		});
	</script>
</head>

<body>
	<table>
		<tr>
			<td valign="top" width="50%">
				<p>Click "Open" to create a connection to the server,
					"Send" to send a message to the server and "Close" to close the connection.
					You can change the message and send multiple times.
				<p>
				<form>
					<button id="close">Close</button>
					<button id="open">Open</button>
				</form>
			</td>
			<td valign="top" width="50%">
				<div id="output" style="max-height: 70vh;overflow-y: scroll;"></div>
			</td>
		</tr>
	</table>
</body>

</html>
